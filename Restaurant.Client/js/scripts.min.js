function goBack(){window.history.back()}function getCookie(e){var t=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return t?decodeURIComponent(t[1]):void 0}var restaurantApp=angular.module("restaurantApp",["ngSanitize","ngRoute","ngAnimate","menuApp"]);restaurantApp.config(["$routeProvider",function(e){e.when("/start",{template:"",controller:"getParamsCtrl"}).when("/home",{templateUrl:"views/home.html"}).when("/club_select",{templateUrl:"views/club_select.html"}).when("/club_map",{templateUrl:"views/club_map.html"}).when("/about",{templateUrl:"views/about.html"}).when("/chat",{templateUrl:"views/chat.html"}).when("/shares",{templateUrl:"views/shares.html"}).when("/news/:newsId",{templateUrl:"views/news.html"}).when("/news_list",{templateUrl:"views/news_list.html"}).when("/booking",{templateUrl:"views/booking.html"}).when("/feedback",{templateUrl:"views/feedback.html"}).when("/favorites",{templateUrl:"views/favorites.html"}).when("/reviews",{templateUrl:"views/reviews.html"}).when("/menu_first/:catId",{templateUrl:"views/menu_first.html"}).when("/menu_next/:catId",{templateUrl:"views/menu_next.html"}).when("/menu_last/:prodId",{templateUrl:"views/menu_last.html"}).when("/order",{templateUrl:"views/order.html"}).when("/card_payment",{templateUrl:"views/card_payment.html"}).when("/error",{template:'<div style="margin-top: 100px;">Нет аккаунта бонусной карты</div>'}).otherwise({redirectTo:"/home"})}]),restaurantApp.run(["$routeParams","$rootScope","$location","$timeout","$http","sessionData","userIdService","signalRHubProxy",function(e,t,o,n,r,s,a){if(t.vmm={},t.vmm.bonusCardUlr=s.bonusCardUlr,a.readUserId(),null!==localStorage.getItem("order")&&(s.order=JSON.parse(localStorage.order)),null!==localStorage.getItem("orderID")&&(s.orderID=localStorage.orderID),t.buttonHide=function(){t.vmm.buttonHide="undefined"==localStorage.sessionId||void 0==localStorage.sessionId||localStorage.getItem("agent")?!0:!1},t.vmm.globalPoint=localStorage.getItem("globalPoint"),t.vmm.pointId=localStorage.getItem("point"),t.vmm.userId=getCookie("userId"),t.$on("$routeChangeSuccess",function(){"undefined"==localStorage.sessionId||void 0==localStorage.sessionId||localStorage.getItem("agent")?void 0!=getCookie("userId")?t.vmm.userIsNotRegistred=!1:(o.path("/error"),t.vmm.userIsNotRegistred=!0):(t.vmm.userIsNotRegistred=!1,void 0!=getCookie("userId")&&(t.vmm.userId=getCookie("userId")))}),!localStorage.getItem("point")&&-1==location.hash.search("/start")){if(!localStorage.getItem("status"))var i;for(var u=location.hash,c=["/admin_panel","/admin_auth"],l=c.length-1;l>=0&&(i=u.search(c[l]),-1===i);l--)n(function(){o.path("/club_select")},3e3)}t.buttonHide(),t.$on("$routeChangeSuccess",function(){t.buttonHide()}),t.$on("$routeChangeSuccess",function(){r({method:"GET",url:s.server+"Club/OneClub",params:{pointId:s.clubId}}).success(function(e){t.vmm.clubName=e.Rest.Name,t.vmm.clubNetwork=e.Rest.Network,t.vmm.clubAddress=e.Rest.Address,t.vmm.clubTelephone=e.Rest.Phone})}),t.$on("$routeChangeSuccess",function(){t.vmm.bonusesShow=!1,"undefined"==localStorage.sessionId||void 0==localStorage.sessionId||localStorage.getItem("agent")||r({method:"GET",url:s.server+"User/GetUserBonus",params:{sessionId:s.sessionId}}).success(function(e){0!=e?(t.vmm.bonusesShow=!0,t.vmm.bonuses=e):t.vmm.bonusesShow=!1}).error(function(){t.vmm.bonusesShow=!1})}),t.vmm.addZeroTODate=function(e){return e=e.toString(),e.length<2&&(e="0"+e),e},t.vmm.bonusOverTenThousand=function(){if(t.vmm.bonuses>1e3){var e=Math.floor(t.vmm.bonuses/1e3)+"k";return e}return t.vmm.bonuses},t.vmm.logout=function(){r({method:"GET",url:s.server+"User/CloseSession",params:{sessionId:localStorage.sessionId}}).success(function(){delete localStorage.sessionId,delete s.sessionId,t.vmm.buttonHide=!0,t.vmm.userIsNotRegistred=!0,delete localStorage.orderID,o.path("/home")})},t.vmm.stopPropagation=function(e){e.stopPropagation()},t.go=function(e){o.path(e)},t.goForRegistred=function(e){1!=t.vmm.userIsNotRegistred&&o.path(e)}}]),restaurantApp.controller("chatCtrl",["$scope","$http","sessionData","$timeout","signalRHubProxy",function(e,t,o,n,r){function s(e){return $("<div/>").html(e).text()}var a=this;a.popupShow=!0,localStorage.getItem("userName")&&(a.popupShow=!1),a.userChange=function(){void 0==$(".validate-error")[0]?(a.errorMark=!1,localStorage.userName=a.userName,a.popupShow=!1):a.errorMark=!0},a.imagePath=o.imagePath+"Photo/",a.msgContent="",a.socialConnection=r(),a.socialConnection.connection.start().done(function(){a.socialConnection.social.invoke("Connect",o.sessionId),a.socialConnection.social.invoke("ConnectToConversation",o.sessionId,o.clubId),a.socialConnection.social.invoke("GetMessages",o.sessionId,o.clubId),a.socialConnection.social.invoke("UsersInChat",o.sessionId,o.clubId)}),a.socialConnection.social.on("onMessage",function(e){n(function(){a.scroll=!0},10),a.msgs=e}),a.AddZeroTODate=function(e){return e=e.toString(),1===e.length&&(e="0"+e),e},a.sendMsg=function(t){t=s(t),n(function(){a.scroll=!0},10),e.vm.msgPhotoName?(a.socialConnection.social.invoke("SendMessage",e.vm.msgPhotoName,1,o.sessionId,o.clubId),e.vm.msgPhotoName=null):(a.socialConnection.social.invoke("SendMessage",t,0,o.sessionId,o.clubId),e.vm.msgContent="")},a.socialConnection.startResponse("onConnected",function(){}),a.socialConnection.startResponse("sendMessages",function(e){n(function(){a.scroll=!0},10),a.msgs.push(e)}),a.socialConnection.startResponse("sendMessagesToCaller",function(e){a.msgs.push(e)})}]),restaurantApp.controller("clubSelectCtrl",["$rootScope","$scope","$http","$location","$timeout","sessionData",function(e,t,o,n,r,s){var a=this;a.clubClick=function(t,o,n){localStorage.setItem("point",t),s.clubId=t,localStorage.setItem("pointName",n),localStorage.setItem("globalPoint",o),e.vmm.globalPoint=o,window.history.back()},navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){t.$apply(function(){a.position=e,o({method:"GET",url:s.server+"Club/AllClubs",params:{latitude:e.coords.latitude,longitude:e.coords.longitude}}).success(function(t){function o(){myMap=new ymaps.Map("map",{center:[e.coords.latitude,e.coords.longitude],zoom:10});var o=new ymaps.Placemark([e.coords.latitude,e.coords.longitude],{hintContent:"Мое местоположение"},{iconImageSize:[30,42],iconImageOffset:[-3,-42]});myMap.geoObjects.add(o),$.each(t.Rest,function(){var e=new ymaps.Placemark([this.latitude,this.longitude],{hintContent:String(this.Name)},{iconLayout:"default#image",iconImageHref:"img/balloon.png",iconImageSize:[30,42],iconImageOffset:[-3,-42]});myMap.geoObjects.add(e)})}a.clubs=t.Rest,a.showDistanse=!0,ymaps.ready(o)})})},function(){a.clubsWithOutNavigator()},{frequency:5e3,maximumAge:0,timeout:100,enableHighAccuracy:!0}):a.clubsWithOutNavigator(),a.clubsWithOutNavigator=function(){o({method:"GET",url:s.server+"Club/AllClubs",params:{sessionId:s.sessionId,latitude:null,longitude:null}}).success(function(e){function t(){myMap=new ymaps.Map("map",{center:[55.76,37.64],zoom:10});var e=new ymaps.Placemark([55.76,37.64],{hintContent:"Мое местоположение"},{iconImageSize:[30,42],iconImageOffset:[-3,-42]});myMap.geoObjects.add(e),$.each(a.clubs,function(){var e=new ymaps.Placemark([this.latitude,this.longitude],{hintContent:String(this.Name)},{iconLayout:"default#image",iconImageHref:"img/balloon.png",iconImageSize:[30,42],iconImageOffset:[-3,-42]});myMap.geoObjects.add(e)})}a.clubs=e.Rest,ymaps.ready(t)})},a.functionForChat=function(e){o({method:"GET",url:s.server+"Chat/ConnectToConversation",params:{pointId:e,sessionId:s.sessionId}}).success(function(){})}}]),restaurantApp.controller("clubMapCtrl",["$scope","$http","sessionData",function(e,t,o){var n=this;n.clubClick=function(e,t){localStorage.setItem("point",e),o.clubId=e,localStorage.setItem("pointName",t),window.history.back()},navigator.geolocation?navigator.geolocation.getCurrentPosition(function(r){e.$apply(function(){n.position=r,t({method:"GET",url:o.server+"Club/AllClubs",params:{latitude:r.coords.latitude,longitude:r.coords.longitude}}).success(function(e){function t(){myMap=new ymaps.Map("map",{center:[r.coords.latitude,r.coords.longitude],zoom:10});var t=new ymaps.Placemark([r.coords.latitude,r.coords.longitude],{hintContent:"Мое местоположение"},{iconImageSize:[30,42],iconImageOffset:[-3,-42]});myMap.geoObjects.add(t),$.each(e.Rest,function(){var e=new ymaps.Placemark([this.latitude,this.longitude],{hintContent:String(this.Name),balloonContent:String(this.Name)+"<br>"+String(this.Address)+"<br>Расстояние до клуба: "+String(this.distance)+"<br><button class='club-id' club-id='"+this.PointId+"' club-name='"+this.Name+"'>Перейти</button>"},{iconLayout:"default#image",iconImageHref:"img/balloon.png",iconImageSize:[30,42],iconImageOffset:[-3,-42]});myMap.geoObjects.add(e)})}n.clubs=e.Rest,n.showDistanse=!0,ymaps.ready(t)})})},function(){n.clubsWithOutNavigator()},{frequency:5e3,maximumAge:0,timeout:100,enableHighAccuracy:!0}):n.clubsWithOutNavigator(),n.clubsWithOutNavigator=function(){t({method:"GET",url:o.server+"Club/AllClubs",params:{sessionId:o.sessionId,latitude:null,longitude:null}}).success(function(e){function t(){myMap=new ymaps.Map("map",{center:[55.76,37.64],zoom:10});var e=new ymaps.Placemark([55.76,37.64],{hintContent:"Мое местоположение"},{iconImageSize:[30,42],iconImageOffset:[-3,-42]});myMap.geoObjects.add(e),$.each(n.clubs,function(){var e=new ymaps.Placemark([this.latitude,this.longitude],{hintContent:String(this.Name),balloonContent:String(this.Name)+"<br>"+String(this.Address)+"<br>Расстояние до клуба: "+String(this.distance)+"<br><button class='club-id' club-id='"+this.PointId+"' club-name='"+this.Name+"'>Перейти</button>"},{iconLayout:"default#image",iconImageHref:"img/balloon.png",iconImageSize:[30,42],iconImageOffset:[-3,-42]});myMap.geoObjects.add(e)})}n.clubs=e.Rest,ymaps.ready(t)})}}]),restaurantApp.controller("getParamsCtrl",["$location","$routeParams","$rootScope","userIdService","sessionData","$http",function(e,t,o,n,r,s){var a=this;a.userId=t.userId,a.pointId=t.pointId,n.deleteUserId(),o.vmm.globalPoint=t.pointId,localStorage.setItem("globalPoint",t.pointId),n.setUserId(a.userId),s({method:"GET",url:r.server+"Cabinet/GetSession",params:{pointId:a.pointId,userId:a.userId}}).success(function(t){r.sessionId=t.Session,localStorage.sessionId=t.Session,localStorage.setItem("point",t.point),r.clubId=t.point,o.vmm.pointId=t.point,e.path("/home")})}]),restaurantApp.controller("homeCtrl",["$routeParams","$rootScope","$scope","$http","sessionData","userIdService",function(e,t,o,n,r){var s=this;o.sliderProportions=.57,s.photoPath=r.imagePath+"mainphoto/",n({method:"GET",url:r.server+"Club/GetMainPhotos",params:{pointId:r.clubId}}).success(function(e){s.slides=e;for(var t=s.slides.length-1;t>=0;t--)s.slides[t]={pictureUrl:s.photoPath+s.slides[t].Photo}}),n({method:"GET",url:r.server+"Club/RestNetworkInfo",params:{pointId:r.clubId}}).success(function(e){s.clubDescription=e.ClubDescription})}]),restaurantApp.controller("profileCtrl",["$scope","$http","sessionData",function(e,t,o){var n=this;t({method:"GET",url:o.server+"Cabinet/GetUserInfo",params:{sessionId:o.sessionId}}).success(function(e){n.userName=e[0].Name,n.userEmail=e[0].Email,n.userPhone=e[0].Phone,n.userPhoto=o.imagePath+"photo/"+e[0].Photo}),n.userChange=function(e){void 0==$(".validate-error")[0]&&("name"==e&&t({method:"GET",url:o.server+"Cabinet/NameEdit",params:{sessionId:o.sessionId,name:n.userName}}).success(function(e){e?(popup.popupChangeHide(),n.errorMark=!1):n.errorMark=!0}),"email"==e&&t({method:"GET",url:o.server+"Cabinet/EmailEdit",params:{sessionId:o.sessionId,email:n.userEmail}}).success(function(e){e?(popup.popupChangeHide(),n.errorMark=!1):n.errorMark=!0}),"password"==e&&t({method:"GET",url:o.server+"Cabinet/ChangePassword",params:{sessionId:o.sessionId,oldPassword:n.userPasswordOld,newPassword:n.userPasswordNew}}).success(function(e){e?(popup.popupChangeHide(),n.errorMark=!1):n.errorMark=!0}),"phone"==e&&(n.codeChangeStage=!1,t({method:"GET",url:o.server+"Cabinet/SendSms",params:{phone:n.userPhone,sessionId:o.sessionId}}).success(function(){n.codeChangeStage=!0})))},n.popupCall=function(e){popup.popupChangeShow(e)},n.popupHide=function(){popup.popupChangeHide()},n.changePhone=function(){t({method:"GET",url:o.server+"Cabinet/ChangePhone",params:{code:n.userCode,sessionId:o.sessionId,newPhone:n.userPhone}}).success(function(e){e?(popup.popupChangeHide(),n.errorMark=!1,n.codeChangeStage=!1):n.errorMark=!0})},n.changePhoto=function(){var e=new FormData,r=document.getElementById("file").files[0];e.append("file",r),t({method:"POST",url:o.server+"Cabinet/AddUserPhoto",data:e,headers:{"Content-Type":void 0}}).success(function(e){n.userPhoto=o.imagePath+"photo/"+e.photo,t({method:"get",url:o.server+"Cabinet/PhotoEdit",params:{sessionId:o.sessionId,photo:e.photo}}).success(function(){})})}}]),restaurantApp.controller("menuCtrl",["$rootScope","$scope","$location","$http","$routeParams","sessionData",function(e,t,o){t.goBack=goBack,t.$on("$routeChangeSuccess",function(){t.clubName=localStorage.pointName;for(var n=location.hash,r=["/admin_panel","/admin_auth"],s=r.length-1;s>=0;s--){if(result=n.search(r[s]),-1!==result){e.hideMenuValue=!0;break}e.hideMenuValue=!1}for(var s=r.length-1;s>=0;s--){if(result=n.search(r[s]),-1!==result){e.vmm.hideBurgerValue=!0;break}e.vmm.hideBurgerValue=!1}null===localStorage.getItem("point")&&(e.vmm.hideBurgerValue=!0);for(var a=["/password_recovery","/authorization","/registration","/club_map","/menu_first/","/menu_next","/menu_last","/favorites","/enter","/news/","/order"],s=a.length-1;s>=0;s--){if(result=n.search(a[s]),-1!==result){t.backMenuValue=!0;break}t.backMenuValue=!1}for(var i=["/menu_first/null"],s=i.length-1;s>=0;s--)if(result=n.search(i[s]),-1!==result){t.backMenuValue=!1;break}for(var u=["/club_map","/club_select","/authorization","/registration"],s=u.length-1;s>=0;s--){if(result=n.search(u[s]),-1!==result){t.vipadaika=!1;break}t.vipadaika=!0}for(var c=["/club_select"],s=c.length-1;s>=0;s--){if(result=n.search(c[s]),-1!==result){t.vipadaikaBack=!1;break}t.vipadaikaBack=!0}t.goToFromTopMenuClick=function(){0==t.vipadaikaBack&&t.goBack(),1==t.vipadaika&&o.path("/club_select")};for(var l=["/club_select","/authorization","/registration"],s=l.length-1;s>=0;s--){if(result=n.search(l[s]),-1!==result){t.cart=!1;break}t.cart=!0}})}]),restaurantApp.controller("sharesCtrl",["$scope","$http","$routeParams","sessionData",function(e,t,o,n){var r=this;r.imagePath=n.imagePath+"article/",t({method:"GET",url:n.server+"Article/Article",params:{pointId:n.clubId}}).success(function(e){r.shares=e.article})}]),restaurantApp.controller("bonusesCtrl",["$scope","$http","$routeParams","sessionData",function(){var e=this;e.ifNotAuthorized=!1,localStorage.getItem("sessionId")||(e.ifNotAuthorized=!0)}]),restaurantApp.controller("reviewsCtrl",["$scope","$http","$timeout","sessionData","customFunctions",function(e,t,o,n,r){var s=this;s.maxlength=!1,s.review="",s.scrollPage=function(){r.scrollToBottomReview()},s.scrollPageNoAnimate=function(){r.scrollToBottomReviewNoAnimate()},s.refreshReviewsList=function(){t({method:"GET",url:n.server+"Cabinet/GetReviewList",params:{pointId:n.clubId}}).success(function(e){s.listOfReviews=e,o(function(){s.scroll=!0},10)})},s.refreshReviewsList(),s.sendReview=function(){""==s.review?s.noMessage=!0:t({method:"POST",url:n.server+"Cabinet/SendReview",data:{pointId:n.clubId,sessionId:n.sessionId,comment:s.review}}).success(function(){s.review="",o(function(){s.messageSent=!1},3e3),s.messageSent=!0,s.refreshReviewsList(1)})}}]),restaurantApp.controller("historyCtrl",["$scope","$http","$routeParams","sessionData",function(e,t,o,n){var r=this;t({method:"GET",url:n.server+"Cabinet/GetOrderHistory",params:{sessionId:n.sessionId}}).success(function(e){r.orders=e.orderHistory})}]),restaurantApp.controller("bookingCtrl",["$scope","$http","$timeout","sessionData",function(e,t,o,n){var r=this;r.bookingSuccess=!1;var s=new Date;r.day=s.getDate(),r.month=s.getMonth()+1,r.hour=18,r.minute=30,r.comment="",t({method:"GET",url:n.server+"Cabinet/GetUserInfo",params:{sessionId:n.sessionId}}).success(function(e){r.userPhone=e[0].Phone}).error(function(){r.userPhone=""});r.hour+":"+r.minute;r.sendReservationRequest=function(){""==r.userPhone?r.noMessage=!0:t({method:"GET",url:n.server+"Cabinet/ReservationTable",params:{hour:r.hour,minute:r.minute,day:r.day,month:r.month,year:s.getFullYear(),phone:r.userPhone,people:r.peopleQuantity,comment:r.comment,pointId:n.clubId}}).success(function(){r.bookingSuccess=!0})}}]),restaurantApp.controller("feedbackCtrl",["$scope","$http","$timeout","sessionData",function(e,t,o,n){var r=this;r.noMessage=!1,r.messageSent=!1,r.comment="",t({method:"GET",url:n.server+"Cabinet/GetUserInfo",params:{sessionId:n.sessionId}}).success(function(e){r.userPhone=e[0].Phone,r.userEmail=e[0].Email}).error(function(){r.userPhone="",r.userEmail=""}),r.sendFeedback=function(){""==r.comment||""==r.userPhone||""==r.userEmail?r.noMessage=!0:t({method:"POST",url:n.server+"Cabinet/LeaveFeedback",data:{pointId:n.clubId,phone:r.userPhone,email:r.userEmail,comment:r.comment}}).success(function(){r.messageSent=!0})}}]),restaurantApp.controller("newsListCtrl",["$scope","$http","sessionData",function(e,t,o){var n=this;t({method:"GET",url:o.server+"News/News",params:{pointId:o.clubId}}).success(function(e){n.news=e})}]),restaurantApp.controller("newsCtrl",["$scope","$http","$routeParams","sessionData",function(e,t,o,n){var r=this;r.imagePath=n.imagePath+"news/",e.$on("$routeChangeSuccess",function(){var e=o.newsId;t({method:"GET",url:n.server+"News/OneNews",params:{newsId:e}}).success(function(e){r.newsName=e.Name,r.newsDescription=e.Description,r.newsImage=e.Image})})}]),restaurantApp.controller("bottomMenuCtrl",["$rootScope","$scope","$http","$routeParams","sessionData","$location",function(e,t,o,n,r,s){var a=this;t.goBack=goBack,a.Name=t.clubName,a.goToChat=function(){e.vmm.userIsNotRegistred||s.path("/chat")},t.$on("$routeChangeSuccess",function(){t.clubName=localStorage.pointName;for(var o=location.hash,n=["/enter","/registration","/admin_panel","/admin_auth","/authorization"],r=n.length-1;r>=0;r--){if(result=o.search(n[r]),-1!==result){e.vmm.hideBottomMenuValue=!0;break}e.vmm.hideBottomMenuValue=!1}null===localStorage.getItem("point")&&(e.vmm.hideBottomMenuValue=!0)})}]),restaurantApp.controller("aboutCtrl",["$scope","$http","$routeParams","sessionData",function(e,t,o,n){var r=this;r.slides=[],e.sliderProportions=.57,t({method:"GET",url:n.server+"Club/RestNetworkInfo",params:{pointId:n.clubId}}).success(function(e){r.ClubDescription=e.ClubDescription,r.address=e.ClubAddress,r.workingHours=e.WorkTime,r.phone=e.ClubTelephone,r.email=e.Email;for(var t=e.Photos.length-1;t>=0;t--)r.slides[t]={pictureUrl:"http://stas.intouchclub.ru/intouchsoft/Content/Restaurant/gallery/"+e.Photos[t].PhotoName}})}]),restaurantApp.controller("downloadAppCtrl",["$scope","$http","$routeParams","sessionData",function(){}]),restaurantApp.directive("theLastSlideScript",function(){return function(e){function t(e){jQuery(function(e){e(".touchslider").touchSlider({mouseTouch:!0,autoplay:!0,delay:5e3})}),$(document).ready(function(){var t=parseInt($(".slider").css("width"));$(".slider").css("height",t*e*1.2+"px");var o=Math.round(t*e)+"px";$(".touchslider-item").css("width",t+"px"),$(".touchslider-item").css("height",o),$(".touchslider-item").parent().css("height",o),$(".touchslider-viewport").css("height",o),$(".touchslider1").css("height",o)})}e.$last&&t(e.sliderProportions)}}),restaurantApp.directive("myMaxlength",["$compile",function(){return{restrict:"A",scope:{},require:"ngModel",link:function(e,t,o,n){o.$set("ngTrim","false");var r=parseInt(o.myMaxlength,10);n.$parsers.push(function(t){return t.length>r&&(e.$parent.vm.maxlength=!0,t=t.substr(0,r),n.$setViewValue(t),n.$render()),t})}}}]),restaurantApp.directive("contenteditable",["$sce",function(e){return{restrict:"A",require:"?ngModel",link:function(t,o,n,r){function s(){var e=o.html();n.stripBr&&"<br>"==e&&(e=""),r.$setViewValue(e)}r&&(r.$render=function(){o.html(e.getTrustedHtml(r.$viewValue||""))},o.on("blur keyup change",function(){t.$evalAsync(s)}),s())}}}]),restaurantApp.directive("popupCloseAble",function(){return{restrict:"A",scope:{ngShowModel:"=ngShow"},link:function(e,t){$(t).on("click",function(){e.ngShowModel=!1,e.$apply()}),$(t).find("*").on("click",function(e){e.stopPropagation()})}}}),restaurantApp.directive("myDirective",["httpPostFactory",function(e){return{restrict:"A",scope:{},link:function(t,o){o.bind("change",function(){var n=new FormData;n.append("file",o[0].files[0]),e("Chat/AddMessagePhoto",n,function(e){t.$parent.vm.msgPhotoName=e.photo})})}}}]),restaurantApp.directive("topMenu",function(){return{restrict:"E",replace:!0,templateUrl:"views/modules/topmenu.html",link:function(){}}}),restaurantApp.directive("bottomMenu",function(){return{restrict:"E",replace:!0,templateUrl:"views/modules/bottommenu.html",link:function(){}}}),restaurantApp.directive("inputJumpNext",function(){return{restrict:"A",replace:!1,link:function(e,t){$(t).keyup(function(){this.value.length==$(this).attr("maxlength")&&$(this).next().focus()})}}}),restaurantApp.directive("inputValidate",["validationService",function(e){return{restrict:"E",replace:!0,link:function(t,o){o.append($("<div>",{"class":"validate-sign",html:"Ошибка"})),$(o).find("input").on("blur",function(){e.validateFunction(this)})}}}]),restaurantApp.directive("sideMenu",["sessionData",function(e){return{restrict:"E",replace:!0,templateUrl:"views/modules/sidemenu.html",link:function(t,o){$(function(){t.bonusCardUrl=e.bonusCardUrl;var n=$("#sidebar"),r=($("#sidebar").find(".nav"),-1*parseInt(n.css("width"))),s=$(".shade");$(window).on("resize",function(){r=-1*parseInt(n.css("width")),n.css("transform","translateX("+r+"px)")});var a=function(){n.removeClass("show"),s.removeClass("show"),n.css("transform","translateX("+r+"px)"),n.css("-webkit-transform","translateX("+r+"px)"),sidebarCurrentPosition=r,$(".nav").scrollTop(0)};a();var i=function(){n.addClass("transition"),n.css("transform",""),n.css("-webkit-transform",""),n.addClass("show"),s.addClass("show"),sidebarCurrentPosition=0};$(document).on("click",".wrap",function(){$(o).hasClass("show")&&a()}),$(document).on("click",".wrap li",function(){$(o).hasClass("show")&&a()}),$(document).on("click","#sidebar",function(e){e.stopPropagation()}),$(document).on("click",".menu",function(e){e.stopPropagation(),$(o).hasClass("show")?a():i()}),$(document).on("click",".link-logout",function(e){e.stopPropagation()}),$(document).on("click",".nav .disabled",function(e){e.stopPropagation()});{var u=document.getElementById("sidebar"),c=new Hammer(u);window.getComputedStyle($("#sidebar").get(0))}c.on("pan",function(e){if(!n.hasClass("show")){n.removeClass("transition");var t=(n.css("transform"),e.deltaX+sidebarCurrentPosition);n.css("transform","translateX("+t+"px)"),n.css("-webkit-transform","translateX("+t+"px)"),e.deltaX>50&&s.addClass("show")}if(n.hasClass("show")&&e.deltaX<0){n.removeClass("transition");var t=(n.css("transform"),e.deltaX+sidebarCurrentPosition);n.css("transform","translateX("+t+"px)"),n.css("-webkit-transform","translateX("+t+"px)")}}),c.on("panend",function(e){n.css("transform",""),n.addClass("transition"),e.deltaX>30&&i(),e.deltaX<=-70&&a()})})}}}]),restaurantApp.directive("popupBlock",["validationServiсe",function(){return{restrict:"E",replace:!0,templateUrl:"views/modules/popup_block.html",link:function(){}}}]),restaurantApp.directive("button",[function(){return{restrict:"C",link:function(e,t){$(t).on("mousedown",function(){$(this).addClass("tap")}),$(t).on("mouseup",function(){var e=this;setTimeout(function(){$(e).removeClass("tap")},500)})}}}]),restaurantApp.directive("autoscroll",[function(){return{restrict:"A",scope:{autoscroll:"="},link:function(e,t){e.$watch(function(){return e.autoscroll},function(o){if(o){{parseInt($(t)[0].scrollHeight)}$(t).animate({scrollTop:9999999},1e3),e.$evalAsync(function(){e.autoscroll=null})}})}}}]),restaurantApp.value("sessionData",{userId:null,sessionId:localStorage.sessionId,server:"http://anton.intouchclub.ru/RestWeb/",clubId:localStorage.point,imagePath:"http://anton.intouchclub.ru/Content/Restaurant/",order:[],bonuses:0,SocialServer:"http://anton.intouchclub.ru/SocRest/signalr",HubName:"restHub",bonusCardUrl:"http://artem.intouchclub.ru/BonusCard"}),restaurantApp.service("userIdService",["$rootScope","sessionData",function(e,t){return{setUserId:function(e){document.cookie="userId="+e+"; expires=Tue, 19 Jan 2038 03:14:07 GMT"},checkUserId:function(){},readUserId:function(){t.userId=getCookie("userId")},deleteUserId:function(){document.cookie="userId=; expires="}}}]),restaurantApp.service("validationService",function(){var e={validateFormsForced:function(){$("input-validate").each(function(){$(this).append($("<div>",{"class":"validate-sign",html:"Ошибка"})),e.validateFunction($(this).find("input")[0])})},validateFunction:function(e){var t=$(e).val(),o=$(e).closest("input-validate"),n=/./;"text"==e.getAttribute("type")&&(n=/./),"password"==e.getAttribute("type")&&(n=/./),"email"==e.getAttribute("type")&&(n=/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,6})+$/),"number"==e.getAttribute("type")&&(n=/^\d+$/),"tel"==e.getAttribute("type")&&(n=/./),0==n.test(t)?(o.removeClass("validate-ok"),o.addClass("validate-error")):(o.addClass("validate-ok"),o.removeClass("validate-error"));var r=e.getAttribute("data-confirmID");if(void 0!=r){var s=$("#"+r)[0];if("password"==s.getAttribute("type")){var a=$(s).val();if(t!==a)return o.removeClass("validate-ok"),o.addClass("validate-error"),o.find(".validate-sign").html("Не совпадает"),!1;o.addClass("validate-ok"),o.removeClass("validate-error")}}}};return e}),restaurantApp.service("popup",[function(){var e={popupChangeShow:function(e){$("form").on("click",function(e){e.stopPropagation()}),$(".popup-change").fadeIn(),"name"==e&&$(".change-name").show(),"email"==e&&$(".change-email").show(),"password"==e&&$(".change-password").show(),"phone"==e&&$(".change-phone").show()},popupChangeHide:function(){$(".popup-change").fadeOut(function(){$(".popup-change > form").hide()})},popupShow:function(){$("form").on("click",function(e){e.stopPropagation()})},checkValid:function(){return void 0==$(".validate-error")[0]?!0:void 0}};return e}]),restaurantApp.factory("httpPostFactory",["$http","sessionData",function(e,t){return function(o,n,r){e({url:t.server+o,method:"POST",data:n,headers:{"Content-Type":void 0}}).success(function(e){r(e)})}}]),restaurantApp.service("signalRHubProxy",["$rootScope","sessionData",function(e,t){function o(){var o=$.hubConnection(t.SocialServer),n=o.createHubProxy(t.HubName);return n.on("ontest",function(){console.log("нет сессии!")}),o.start().done(function(){}),{social:n,connection:o,startResponse:function(t,o){n.on(t,function(t){e.$apply(function(){o&&o(t)})})},endResponse:function(e){n.off(e)},response:function(t,o){n.off(t),n.on(t,function(t){e.$apply(function(){o&&o(t)})})}}}return o}]),restaurantApp.service("customFunctions",function(){var e={scrollToBottom:function(){$(".page div").animate({scrollTop:$(".page div")[0].scrollHeight},1e3)},scrollToTop:function(){$(".page div").animate({scrollTop:0},1e3)}};return e});var menuApp=angular.module("menuApp",["ngAnimate"]);menuApp.run(["$rootScope","$location","$http","$interval","menuData","sessionData","signalRHubProxy",function(e,t,o,n,r,s){e.vmMenu={},e.vmMenu.imagePath=s.imagePath+"icons/menu/",e.vmMenu.waitingForOrderConfirm=function(){e.vmMenu.hasOpenOrder=!1;var t=n(function(){o({method:"GET",url:s.server+"Order/ActiveInactive",params:{sessionId:s.sessionId}}).success(function(o){1==o?(n.cancel(t),e.vmMenu.hasOpenOrder=!1):e.vmMenu.hasOpenOrder=!0}).error(function(){n.cancel(t),e.vmMenu.hasOpenOrder=!1})},1e4)},e.vmMenu.waitingForOrderConfirm(),e.vmMenu.toggleCartBadge=function(){for(var t=0,o=s.order.length-1;o>=0;o--)t+=parseInt(s.order[o].Quantity);e.vmMenu.orderLength=t,e.vmMenu.badgeShow=e.vmMenu.orderLength>0?!0:!1},e.$on("$routeChangeSuccess",function(){e.vmMenu.toggleCartBadge()}),e.vmMenu.toggleCartBadge(),e.vmMenu.changeAmount=function(t,o,n,r,a){var i=$(t.currentTarget).closest(".quantity").find("input"),u=$(t.currentTarget).closest(".cart-item");if("+"==o){var c=e.vmMenu.quantityRepeat[a];++c,e.vmMenu.quantityRepeat[a]=c,i.val(c)}if("-"==o){var c=e.vmMenu.quantityRepeat[a];c>1?(c--,e.vmMenu.quantityRepeat[a]=c,i.val(c)):(c--,e.vmMenu.quantityRepeat[a]=c,i.val(c),u.remove(),1==s.order.length&&(e.vmMenu.ifNoOrder=!0))}e.vmMenu.refreshOrderList(t,n)},e.vmMenu.refreshOrderList=function(){s.order=[],localStorage.order="",$(".cart-item").each(function(){var e=$(this).find(".cart-count-number").val(),t=$(this).find("input[type=hidden]").attr("data-productId");s.order.push({ProductId:t,Quantity:e})});var t=JSON.stringify(s.order);localStorage.order=t,e.vmMenu.toggleCartBadge()},e.vmMenu.addToOrderList=function(t,o,n){t.stopPropagation();for(var r=!1,a=s.order.length-1;a>=0;a--)for(key in s.order[a])if(s.order[a].ProductId==o){var i=parseInt(s.order[a].Quantity);s.order[a]={ProductId:o,Quantity:n+i};var u=JSON.stringify(s.order);localStorage.order=u,e.vmMenu.toggleCartBadge();var r=!0;break}if(void 0!=o&&void 0!=n&&!r){s.order.push({ProductId:o,Quantity:n});var u=JSON.stringify(s.order);localStorage.order=u,e.vmMenu.toggleCartBadge()}e.vmMenu.toggleCartBadge()}}]),menuApp.controller("menuFirstCtrl",["$scope","$http","sessionData","$routeParams",function(e,t,o,n){var r=this;r.server=o.server;e.$on("$routeChangeSuccess",function(){var e=n.catId;t({method:"GET",url:o.server+"Menu/CatMenu",params:{restId:o.clubId,catId:e}}).success("null"==e?function(e){r.items=e}:function(e){r.itemsNext=e.Array})})}]),menuApp.controller("menuNextCtrl",["$rootScope","$scope","$http","sessionData","$routeParams","menuBounce",function(e,t,o,n,r,s){var a=this;a.bounce=function(){s.badgeBounce()},t.$on("$routeChangeSuccess",function(){var e=r.catId;"undefined"!==e&&o({method:"GET",url:n.server+"Menu/CatProd",params:{categoryId:e,sessionId:n.sessionId}}).success(function(e){a.items=e.Array,a.parentBlock=e.Parent,a.statusOfPage=e.status,a.parentImage=n.imagePath+"icons/menu/"+e.Logo})})}]),menuApp.controller("menuLastCtrl",["$scope","$http","sessionData","$routeParams","menuBounce",function(e,t,o,n,r){var s=this;s.bounce=function(){r.badgeBounce()},e.$on("$routeChangeSuccess",function(){var e=n.prodId;"undefined"!==e&&t({method:"GET",url:o.server+"Menu/OneProd",params:{productId:e,sessionId:o.sessionId}}).success(function(e){s.info=e[0],s.Name=e[0].Name,s.Id=e[0].Id,s.Parent=e[0].Parent,s.Price=e[0].Price,s.Weight=e[0].Weight,s.inFavorites=e[0].Favorite})}),s.addToFavorites=function(){t({method:"GET",url:o.server+"Menu/AddProdToFavorite",params:{prodId:s.Id,sessionId:o.sessionId}}).success(function(){})}}]),menuApp.controller("orderCtrl",["service.orders","$rootScope","$scope","$location","$http","$interval","$timeout","sessionData","customFunctions",function(e,t,o,n,r,s,a,i,u){var c=this;c.items={},c.amountObj=0,c.addToOrders=e.addToOrders,c.scrollTop=u.scrollToTop,c.ifNoOrder=function(){return i.order.length>0?!1:!0},c.reordering=!1,t.vmm.orderID=localStorage.orderID,t.vmm.orderCode=localStorage.orderCodeForNotConfirmedOrder,c.getCartAmount=function(e){c.amountObj=0;for(var t in e)c.amountObj=c.amountObj+e[t];return c.amountObj},r({method:"GET",url:i.server+"Order/CheckReorder",params:{sessionId:i.sessionId}}).success(function(e){c.orderOptions=e,1==e&&(c.reordering=!0)}),c.getCartList=function(){r({method:"GET",url:i.server+"Order/ProdToBag",params:{products:localStorage.order}}).success(function(e){c.items={},c.items=e,c.amount=function(){for(var e=0,t=c.items.length-1;t>=0;t--)e+=c.items[t].Price*c.items[t].Quantity;return e}}).error(function(){c.items={},o.vmMenu.ifNoOrder=!0})},c.getCartList(),c.getTotal=function(){for(var e=0,t=0;t<c.items.length;t++)e+=c.items[t].Price*c.items[t].Quantity;
return e},c.method=0,c.time={hour:12,minute:0},c.timeToTime=!1,c.popupShowQr=!1,c.popupShowWait=!1,c.popupAuthAsk=!1,c.openOrder=function(e){localStorage.getItem("sessionId")?localStorage.getItem("agent")&&!e?1==c.reordering?r({method:"GET",url:i.server+"Cabinet/GetUserInfo",params:{sessionId:i.sessionId}}).success(function(e){c.phone=e[0].Phone,c.openOrderWithTelephon()}).error(function(){c.popupAuthAsk=!0,c.telephoneShow=!1,localStorage.removeItem("sessionId"),localStorage.removeItem("agent")}):(c.popupAuthAsk=!0,c.telephoneShow=!1):(c.timeHM=c.time.hour+":"+c.time.minute,c.timeToTime===!1&&(c.timeHM=""),r({method:"GET",url:i.server+"Order/OpenOrder",params:{sessionId:i.sessionId,orders:localStorage.order,typeOrder:c.method,pointId:i.clubId,cookTime:c.timeHM}}).success(function(e){1!=e?(c.getOrdersList(),localStorage.orderCodeForNotConfirmedOrder=e.code,t.vmm.orderCode=e.code,i.orderID=e.OrderId,localStorage.orderID=e.OrderId,t.vmMenu.orderID=e.OrderId,(0==c.method||1==c.method)&&(c.timeToTime===!0||c.reordering===!0?(c.popupShowWait=!0,o.vmMenu.waitingForOrderConfirm()):i.orderID!==!1&&c.popupShowQrPopup()),3==c.method&&i.orderID!==!1&&(o.vmMenu.waitingForOrderConfirm(),c.popupShowWait=!0),i.order=[],delete localStorage.order,o.vmMenu.badgeShow=!1):c.havePaidButNotClosedOrders=!0,c.getCartList()})):(c.popupAuthAsk=!0,c.telephoneShow=!1)},c.clearOrder=function(){i.order=[],delete localStorage.order,c.items={},o.vmMenu.badgeShow=!1},c.popupShowQrPopup=function(){c.popupShowQr=!0,o.vmMenu.waitingForOrderConfirm()},c.redirectToMyOrders=function(){0==t.vmMenu.hasOpenOrder&&n.path("/my_orders")},c.openOrderWithTelephon=function(){r({method:"GET",url:i.server+"User/Registration",params:{name:"",password:"",phone:c.phone,email:""}}).success(function(e){"already registered"==e.message?c.alreadyRegistred=!0:(o.vmMenu.waitingForOrderConfirm(),localStorage.sessionId=e.sessionId,i.sessionId=e.sessionId,localStorage.agent=!0,c.openOrder(!0),c.popupAuthAsk=!1,"undefined"!=localStorage.sessionId&&void 0!=localStorage.sessionId)})},c.addToOrder=function(e,o){if(void 0!=e&&void 0!=o){i.order.push({ProductId:e,Quantity:o});var n=$(i.order).serialize();localStorage.order=n,t.vmMenu.toggleCartBadge()}},c.returnHours=function(){var e=new Date,t=e.getHours()+1;return t},c.scrollToBottom=function(){u.scrollToBottom()},"true"==localStorage.agent&&(c.notRegistredUser=!0),o.vmMenu.waitingForOrderConfirm(),c.orders={},c.noOpenedOrder=function(){return void 0!=c.orders.length&&c.orders.length>0?!1:!0},t.vmMenu.orderHasBeenPaid=!1,c.getOrdersList=function(){r({method:"GET",url:i.server+"Cabinet/OrderInfo",params:{orderId:i.orderID,sessionId:i.sessionId}}).success(function(e){0==e.OpenClose&&(c.orders={},c.orders=e.Orders.reverse(),null!=e.TypeOfPayment&&(t.vmMenu.orderHasBeenPaid=!0))})},c.getOrdersList(),c.getAmount=function(e){c.amountObj=0;for(var t in e)c.amountObj=c.amountObj+e[t];return c.amountObj},c.askPrice=function(e){o.vmMenu.hasOpenOrder||o.vmMenu.orderHasBeenPaid||(c.paymantVariantsShow=!0,0==e&&(c.popupCashPayment=!0),1==e&&n.path("/card_payment"),2==e&&r({method:"GET",url:i.server+"Order/ReduceBonusByPurchase",params:{userId:o.vmm.userId,pointId:o.vmm.globalPoint,amount:c.getAmount(c.amount)}}).success(function(e){-1!=e.search(/true/i)?r({method:"GET",url:i.server+"Order/PaymentByBonus",params:{orderId:i.orderID,sessionId:i.sessionId,orderSum:c.getAmount(c.amount)}}).success(function(){c.popupBonusPaymentSuccess=!0}).error(function(){alert("Ошибка!")}):c.popupLowBonuses=!0}))}}]),menuApp.controller("cardCtrl",["$scope","$http","$timeout","$location","sessionData",function(e,t,o,n,r){var s=this;"true"==localStorage.agent&&(s.notRegistredUser=!0),t({method:"GET",url:r.server+"Order/GetOrderSum",params:{orderId:r.orderID,sessionId:r.sessionId}}).success(function(e){s.orderAmount=e}),s.paymentSuccess=function(){t({method:"GET",url:r.server+"Order/PaymentByCard",params:{orderId:r.orderID,sessionId:r.sessionId,orderSum:s.orderAmount}}).success(function(e){s.bonusAmount=e,s.popupBonusesShow=!0}),t({method:"GET",url:r.server+"Order/AddBonusByPurchase",params:{userId:e.vmm.userId,pointId:e.vmm.globalPoint,amount:s.orderAmount}}).success(function(){})}}]),menuApp.controller("favoritesCtrl",["$scope","$http","$location","sessionData","menuBounce",function(e,t,o,n,r){var s=this;s.bounce=function(){r.badgeBounce()},s.noSessionId=!1,s.noFavorites=!1,t({method:"GET",url:n.server+"Menu/GetFavorite",params:{sessionId:n.sessionId}}).success(function(e){s.items=e,0==s.items.length&&(s.noFavorites=!0)}).error(function(){s.noSessionId=!0})}]),menuApp.directive("ngFavorites",["$timeout","$http","menuData","sessionData","$location",function(e,t,o,n){return{restrict:"A",scope:{},link:function(o,r,s){localStorage.getItem("sessionId")||$(r).hide();for(var a,i=function(){$(r).on("click",function(e){e.stopPropagation(),t({method:"GET",url:n.server+"Menu/RemoveProdFromFavorite",params:{sessionId:n.sessionId,prodId:s.ngFavorites}}).success(function(e){1==e&&($(r).fadeOut(10,function(){$(r).toggleClass("out-of-favorites")}),$(r).fadeIn())})})},u=function(){$(r).on("click",function(e){e.stopPropagation(),t({method:"GET",url:n.server+"Menu/AddProdToFavorite",params:{prodId:s.ngFavorites,sessionId:n.sessionId}}).success(function(){$(r).fadeOut(10,function(){$(r).toggleClass("out-of-favorites")}),$(r).fadeIn()})})},c=location.hash,l=["/favorites"],d=l.length-1;d>=0;d--)a=c.search(l[d]),-1!==a?i():e(u,0)}}}]),menuApp.directive("ngDeleteButton",[function(){return{restrict:"A",scope:{},link:function(e,t){$(t).on("click",function(){for(var e=parseInt($(t).prev(".quantity").find(".cart-count-number").val()),o=$(t).prev(".quantity").find(".minus"),n=e-1;n>=0;n--)o.trigger("click")})}}}]),menuApp.directive("ngActiveElement",[function(){return{restrict:"A",scope:{},link:function(e,t){$(t).on("mousedown",function(){$(this).addClass("tap")}),$(t).on("mouseup",function(){var e=this;setTimeout(function(){$(e).removeClass("tap")},500)})}}}]),menuApp.value("menuData",{arrayOfFavoritId:[]}),restaurantApp.service("menuBounce",function(){var e={badgeBounce:function(){$(".cart .badge").toggleClass("bounce"),setTimeout(function(){$(".cart .badge").toggleClass("bounce")},500)}};return e}),menuApp.service("service.orders",["$rootScope","sessionData",function(e,t){var o={addToOrders:function(o,n,r){for(var s=!1,a=t.order.length-1;a>=0;a--)for(key in t.order[a])if(t.order[a].ProductId==r){t.order[a].Quantity++;var i=JSON.stringify(t.order);localStorage.order=i,e.vmMenu.toggleCartBadge();var s=!0;break}if(!s){t.order.push({ProductId:r,Quantity:1});var i=JSON.stringify(t.order);localStorage.order=i,e.vmMenu.toggleCartBadge()}e.vmMenu.toggleCartBadge()}};return o}]);